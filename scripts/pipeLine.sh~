#!/bin/bash

## filter and tirm in one step ## harsh
usearch -fastq_filter $1 -fastq_trunclen 250 -fastq_maxee 0.5 -fastq_truncqual 15 -fastaout $1.filtered.fasta 

## get a "sample identifier" to start right after the >
sed -i 's/>RECORD:/>/ig' $1.filtered.fasta
sed -i 's/-/_/ig' $1.filtered.fasta

## dereplicate
usearch -derep_fulllength $1.filtered.fasta -fastaout $1.uniques.fasta -sizeout 

## cluster
usearch -cluster_otus $1.uniques.fasta -otus $1.otus.fa -uparseout $1.out.up -relabel OTU -minsize 2

usearch -usearch_global $1.filtered.fasta -db $1.otus.fa -strand plus -id 0.97 -otutabout $1.otu_table.txt -biomout otu_table.json

## the OTU sequences have tax=xxx; annotations, these will be included
## as an extra column in the tabbed file or as taxonomy metadata in
## the BIOM file. These annotations can be generated using the
## -fastaout option of the utax command, e.g.:

## usearch -utax otus.fa -db 16s.udb -strand both -fastaout otus_tax.fa
